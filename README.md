# Навык для Алисы — OpenRouter Chat

Серверный бэкенд для навыка Яндекс.Алисы, который проксирует запросы в OpenRouter (или Gemini) и ведёт себя как современный голосовой помощник на базе LLM. Навык хранит контекст общения, умеет продолжать генерацию в фоне и поддерживает голосовую команду для переключения моделей.

## Возможности

- Персонализированный стиль ответов и автоматическое продолжение длинных сообщений по запросу пользователя.
- Сохранение истории диалога в `storage/conversations`, поэтому навык держит контекст между репликами.
- Фоновая догрузка ответа, если OpenRouter задерживается: пользователь слышит «Надо подумать…», а результат придёт позже.
- Голосовое переключение моделей командами «переключи модель»/«смени модель» с мгновенным подтверждением «переключаю на: … модели.»
- Приветствие «<model_name> на связи!» — всегда видно, какая модель активна.
- Конфигурация через `.env` и список моделей в `models.txt`.

## Требования

- PHP 8.1+ (рекомендуется для производительности и безопасности)
- Composer
- PHP-расширение cURL
- Веб-сервер с поддержкой PHP-FPM/NGINX/Apache или другой способ запускать `index.php`

## Установка и настройка

1. **Склонируйте репозиторий и перейдите в директорию проекта**

    ```bash
    git clone https://github.com/legale/alice-deepseek.git
    cd alice-deepseek
    ```

2. **Установите зависимости**

    ```bash
    composer install
    ```

3. **Создайте файл окружения**

    ```bash
    cp .env.example .env
    ```

4. **Заполните `.env`**

    ```ini
    MODEL_ID=openai/gpt-oss-20b:free
    OPENROUTER_API_KEY=ваш_ключ_OpenRouter
    # опционально: GEMINI_API_KEY=...
    # опционально: OPENROUTER_SITE_URL=https://ваш-домен
    # опционально: OPENROUTER_APP_NAME=Alice LLM Voice
    ```

    - `MODEL_ID` — стартовая модель, если нет сохранённого состояния.
    - `OPENROUTER_API_KEY` — основной ключ (если пропущен, используется `GEMINI_API_KEY`).
    - `OPENROUTER_SITE_URL` и `OPENROUTER_APP_NAME` попадут в заголовки, как рекомендует OpenRouter.

5. **Укажите доступные модели**

    Укажите модели для циклического переключения в `models.txt`. Пример:

    ```
    openai/gpt-oss-20b:free
    nvidia/nemotron-nano-9b-v2:free
    cognitivecomputations/dolphin-mistral-24b-venice-edition:free
    google/gemma-3-27b-it:free
    ```

    Файл читается построчно, пустые строки игнорируются. Активная модель хранится в `storage/model_state.json`, поэтому навык запоминает выбор после голосовой команды.

6. **Подготовьте директории хранения**

    В процессе работы скрипт создаёт `storage/pending`, `storage/conversations` и `storage/model_state.json`. Убедитесь, что у PHP есть права на запись.

7. **Разверните код и настройте вебхук**

    - Опубликуйте `index.php` на сервере с HTTPS.
    - В кабинете https://dialogs.yandex.ru/developer создайте навык Алисы и укажите публичный URL `https://ваш-домен/index.php` в качестве обработчика вебхука.

## Использование

- Навык держит контекст: история каждой сессии хранится и учитывается при следующих запросах.
- Ответы краткие, без лишних приветствий; длинные сообщения делятся на части.
- Если генерация превышает лимит времени, пользователь слышит `Надо подумать…`, а результат догружается из фоновой обработки.
- Команды «переключи модель»/«смени модель» выбирают следующую модель из списка и сразу подтверждают действие.
- При запуске сессии навык говорит «<model_name> на связи!» — можно отследить активную LLM.

## Полезные ссылки

- OpenRouter API: https://openrouter.ai/
- Документация по навыкам Алисы: https://yandex.ru/dev/dialogs/alice/doc/
- Проект-первоисточник: https://github.com/peleccom/chat_gpt_yandex_alice

## Лицензия

Проект распространяется под лицензией MIT. Текст лицензии расположен в `LICENSE`.
