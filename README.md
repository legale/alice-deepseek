# Навык для Алисы — OpenRouter Chat

Этот репозиторий содержит серверную часть навыка для Яндекс.Алисы, которая проксирует запросы в OpenRouter (или Gemini) и возвращает ответы как будто вы общаетесь с DeepSeek Chat. Навык поддерживает короткие ответы, умеет откладывать долгие запросы в фон и позволяет голосом переключать используемую LLM.

## Возможности

- Быстрые ответы в пределах SLA Алисы с автоматическим переходом в фоновый режим для долгих генераций.
- Сохранение истории в `storage/conversations` и отложенных ответов в `storage/pending`.
- Простое переключение модели командами «переключи модель» или «смени модель».
- Приветствие и подсказки с использованием названия активной модели.
- Гибкая конфигурация через `.env`, включая заголовки OpenRouter с Referer и названием приложения.

## Требования

- PHP 7.4+
- Composer
- PHP-расширение cURL
- Веб-сервер с поддержкой PHP-FPM или аналогичной конфигурации

## Установка и настройка

1. **Склонируйте репозиторий и перейдите в директорию проекта**

    ```bash
    git clone https://github.com/legale/alice-deepseek.git
    cd alice-deepseek
    ```

2. **Установите зависимости**

    ```bash
    composer install
    ```

3. **Создайте файл окружения**

    ```bash
    cp .env.example .env
    ```

4. **Заполните `.env`**

    ```ini
    MODEL_ID=openai/gpt-oss-20b:free
    OPENROUTER_API_KEY=ваш_ключ_OpenRouter
    # опционально: GEMINI_API_KEY=...
    # опционально: OPENROUTER_SITE_URL=https://ваш-домен
    # опционально: OPENROUTER_APP_NAME=Alice DeepSeek
    ```

    - `MODEL_ID` — стартовая модель.
    - `OPENROUTER_API_KEY` — основной ключ (если не указан, используется `GEMINI_API_KEY`).
    - Параметры `OPENROUTER_SITE_URL` и `OPENROUTER_APP_NAME` автоматически попадут в заголовки рекомендованные OpenRouter.

5. **Укажите доступные модели**

    Отредактируйте `models.txt`, перечислив модели для циклического переключения. Пример:

    ```
    openai/gpt-oss-20b:free
    nvidia/nemotron-nano-9b-v2:free
    cognitivecomputations/dolphin-mistral-24b-venice-edition:free
    google/gemma-3-27b-it:free
    ```

    Файл читается построчно. Пустые строки игнорируются. Активная модель сохраняется в `storage/model_state.json` и восстанавливается между запросами.

6. **Подготовьте директории хранения**

    В процессе работы скрипт создаёт `storage/pending`, `storage/conversations` и `storage/model_state.json`. Убедитесь, что у PHP есть права на запись.

7. **Разверните код и настройте вебхук**

    - Опубликуйте `index.php` на сервере с HTTPS.
    - В кабинете https://dialogs.yandex.ru/developer создайте навык Алисы и укажите публичный URL `https://ваш-домен/index.php` в качестве обработчика вебхука.

## Использование

- Навык отвечает коротко и по делу: системный промпт задаёт стиль речи.
- Если ответ не готов за несколько секунд, пользователь слышит «Надо подумать…», а генерация продолжается в фоне.
- Произнеся «переключи модель» или «смени модель», пользователь циклически переключает модель из `models.txt`. Алиса ответит «переключаю на: <model> модели.»
- При старте диалога навык представляется «<model> на связи!» — можно проверить текущую модель без переключений.

## Полезные ссылки

- OpenRouter API: https://openrouter.ai/
- Документация по навыкам Алисы: https://yandex.ru/dev/dialogs/alice/doc/
- Проект-первоисточник: https://github.com/peleccom/chat_gpt_yandex_alice

## Лицензия

Проект распространяется под лицензией MIT. Текст лицензии расположен в `LICENSE`.
